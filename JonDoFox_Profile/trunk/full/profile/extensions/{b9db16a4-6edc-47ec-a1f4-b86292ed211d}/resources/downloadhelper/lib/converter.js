/* Copyright (C) 2006-2015 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function TryExecute(){function e(){if(o>=r.length){running=!1;try{t.callback&&t.callback(a.status,a.stdout,a.stderr)}catch(s){}TryExecute()}else{if(t.step)try{step(o)}catch(s){}exports.doExecute(r[o++],function(t,s,n){t&&(o=r.length),a={status:t,stdout:s,stderr:n},e()},t.time,t.directory)}}if(!running&&0!=execQueue.length){running=!0;var t=execQueue.shift(),r=t.argsArray;t.args&&(r=[t.args]);var a,o=0;e()}}function GetConverterInfo(){function e(){Cu["import"]("resource://gre/modules/FileUtils.jsm");var e=["/usr/bin/avconv","/usr/local/bin/avconv","/usr/bin/ffmpeg","/usr/local/bin/ffmpeg"],t=simplePrefs.prefs["converter-path"]||null;return t&&(e.unshift(t),t=null),e.forEach(function(e){try{if(t)return!1;var r=new FileUtils.File(e);return r.exists()&&r.isFile()&&r.isExecutable()?(t=e,!1):!0}catch(a){return!0}}),t}function t(){try{var e=Cc["@mozilla.org/windows-registry-key;1"].createInstance(Ci.nsIWindowsRegKey);if(null==e)return system.warn("No registry service\n"),null;var t="SOFTWARE\\DownloadHelper\\ConvertHelper3";try{e.open(e.ROOT_KEY_LOCAL_MACHINE,t,e.ACCESS_READ|e.WOW64_32)}catch(a){return null}try{var o=e.readStringValue("InstallFolder");if(null==o)return e.close(),null}catch(s){return e.close(),null}try{"no"==e.readStringValue("ReliableVP9")&&(r=!0)}catch(s){}e.close();var n=Cc["@mozilla.org/file/local;1"].createInstance(Ci.nsILocalFile);return n.initWithPath(o),n.exists()?n.isDirectory()?n.isReadable()?(n.append("avconv.exe"),n.exists()?n.isDirectory()?(console.warn(n.path+" is a directory"),null):n.isReadable()?n.isExecutable()?n.path:(console.warn(n.path+" is not executable"),null):(console.warn(n.path+" is not readable"),null):(console.warn(n.path+" does not exist"),null)):(console.warn(o+" is not readable"),null):(console.warn(o+" is not a directory"),null):(console.warn(o+" does not exist"),null)}catch(a){return console.warn("Getting converter binary:",a,a.stack),null}}var r=!1;return binary="winnt"==system.platform?t():e(),{binary:binary,vp9out:r}}function WindowsMigrateLicense(){try{var e=Cc["@mozilla.org/windows-registry-key;1"].createInstance(Ci.nsIWindowsRegKey);if(null==e)return;var t="SOFTWARE\\DownloadHelper\\ConvertHelper";try{e.open(e.ROOT_KEY_CURRENT_USER,t,e.ACCESS_READ)}catch(r){return void console.info("No",t,"entry")}var a=e.readStringValue("CustomerName"),o=e.readStringValue("CustomerEmail"),s=e.readStringValue("LicenseKey");a&&o&&s&&merge(simpleStorage.storage.converter.license,{name:a,email:o,key:s}),e.close()}catch(n){console.warn("Migrating error",_,_.stack)}}function LicenseSign(e){var t=Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties).get("ProfD",Ci.nsIFile).leafName;return utils.md5("converthelper"+t+e.name+e.email+e.key)}function BatchConvert(e,t){var r=[];e.forEach(function(e){var a="mp4",o=/\.([^\.]{1,5})$/.exec(e);o&&(a=o[1]),a=t.ext||t.params.f||a;var s={id:"local:"+e,title:e,extension:a,local:!0,autoExec:"convert",_convert:t,_downloadTarget:e};r.push(s)}),require("hits").newData(r)}const self=require("sdk/self"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,simpleStorage=require("sdk/simple-storage"),simplePrefs=require("sdk/simple-prefs"),merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,system=require("sdk/system"),childProcess=require("sdk/system/child_process"),timers=require("sdk/timers"),sdkFile=require("sdk/io/file"),log=require("log"),Request=require("sdk/request").Request,alerts=require("alerts"),panels=require("panels"),utils=require("utils");var running=!1,execQueue=[];exports.multiExecute=function(e,t,r,a,o){execQueue.push({argsArray:e,callback:t,time:r,step:a,directory:o}),a&&a(-1),TryExecute()},exports.execute=function(e,t,r,a,o){execQueue.push({args:e,callback:t,time:r,step:a,directory:o}),TryExecute()},exports.doExecute=function(e,t,r,a){var o=[],s=[];simplePrefs.prefs["converter-log-calls"]&&log.log({text:"Converter call",details:JSON.stringify(e,null,4)});var n={};a&&(n.cwd=a);var i=childProcess.spawn(simplePrefs.prefs["converter-path"],e,n);i.stdout.on("data",function(e){o.push(e)}),i.stderr.on("data",function(e){if(r){var t=/time=([0-9]+\.[0-9]+)/.exec(e);t&&r(parseFloat(t[1]))}s.push(e)}),i.on("close",function(e){t(e,o.join(""),s.join(""))})},exports.aggregate=function(e,t,r,a){var o=["-y","-i",e.audio,"-i",e.video],s=!1;"h264"==e.videoCodec&&simplePrefs.prefs["converter-aggreg-tune-h264"]&&(s=!0,e.videoCodec="libx264"),e.wm&&e.videoCodec&&e.fps?o=o.concat(["-i",e.wm.qr,"-filter_complex","[1:v][2:v] overlay="+e.wm.x+":"+e.wm.y,"-c:v",e.videoCodec]):(o.push("-c:v"),o.push(s?e.videoCodec:"copy")),s&&(o=o.concat(["-preset","fast","-tune","film","-profile:v","baseline","-level","30"])),o=o.concat(["-c:a","copy","-threads",simplePrefs.prefs["converter-threads"],"-strict","experimental",e.target]),exports.execute(o,function(e,a,o){0==e?t():r({text:_("failed-conversion"),details:o})},a)},exports.assemble=function(e,t,r){var a=["-y","-fflags","+genpts+igndts","-i"],o=[];Cu["import"]("resource://gre/modules/FileUtils.jsm"),e.chunks.forEach(function(t){if(e.directory){var r=new FileUtils.File(t);o.push(r.leafName)}else o.push(t)}),a.push("concat:"+o.join("|")),a=a.concat(["-bufsize","2M","-c","copy","-f","mp4",e.target]),exports.execute(a,function(e,a,o){0==e?t():r({text:_("failed-assembling"),details:o})},void 0,void 0,e.directory)},exports.isPresent=function(){var e=GetConverterInfo();return!!e.binary},exports.check=function(e){function t(t){n=n&&0==t,0==--s&&(simpleStorage.storage.converter.status=n?"ready":"error",e&&e())}var r=null,a=!1;simpleStorage.storage.converter.status="unchecked",simpleStorage.storage.converter.vp9support=!1;var o=GetConverterInfo();if(r=o.binary,a=o.vp9out,r||(simpleStorage.storage.converter.status="missing"),simpleStorage.storage.converter.exePath=r||"",simplePrefs.prefs["converter-path"]=r||"",simpleStorage.storage.converter.formats={},simpleStorage.storage.converter.codecs={},r){var s=2,n=!0;exports.execute(["-codecs"],function(e,r){r.split("\n").forEach(function(e){var t=/^(.)(.)(.)(.)(.)(.)\s+([^\s]+)\s+(.*)/.exec(e);t&&(simpleStorage.storage.converter.codecs[t[7]]={name:t[7],description:t[8],decoding:"D"==t[1],encoding:"E"==t[2],type:t[3],intra:"I"==t[4],lossy:"L"==t[5],lossless:"S"==t[6]})}),simpleStorage.storage.converter.vp9support=!a&&!!simpleStorage.storage.converter.codecs.vp9&&simpleStorage.storage.converter.codecs.vp9.encoding&&simpleStorage.storage.converter.codecs.vp9.decoding,t(e)}),exports.execute(["-formats"],function(e,r){r.split("\n").forEach(function(e){var t=/^\s(D|\s)(E|\s)\s+([^=\s]+)\s+(.*)/.exec(e);t&&(simpleStorage.storage.converter.formats[t[3]]={name:t[3],description:t[4],demuxing:"D"==t[1],muxing:"E"==t[2]})}),t(e)});var i=["vcd","svcd","dvd","dv","dv50"],c=["pal","ntsc","film"];simpleStorage.storage.converter.targets=[],i.forEach(function(e){c.forEach(function(t){simpleStorage.storage.converter.targets.push(t+"-"+e)})})}else e&&e()},exports.info=function(e,t,r){Cu["import"]("resource://gre/modules/FileUtils.jsm");var a=new FileUtils.File(e);return a.exists()?a.isReadable()?void exports.execute(["-i",e],function(e,r,a){var o={},s=/([0-9]+)x([0-9]+)/g.exec(a);s&&(o.width=parseInt(s[1]),o.height=parseInt(s[2])),s=/Duration: ([0-9]{2}):([0-9]{2}):([0-9]{2})\.([0-9]{2})/g.exec(a),s&&(o.duration=3600*parseInt(s[1])+60*parseInt(s[2])+parseInt(s[3])),s=/Video:\s+([^\s\(,]+)/g.exec(a),s&&(o.videoCodec=s[1]),s=/([0-9]+(?:\.[0-9]+)?)\s+fps\b/g.exec(a),s&&(o.fps=parseFloat(s[1])),t(o)}):void r(_("file-not-readable")):void r(_("file-not-exists"))},exports.wmForHeight=function(e,t,r){function a(){0==--n&&(i?(c.exists()&&c.remove(!1),r(ex)):t({x:images[s].x,y:images[s].y,qr:c.path}))}var o=1/0,s=null,n=1,i=null,c=null;for(var l in images){var p=parseInt(l),u=Math.abs(e-p);o>u&&(s=l,o=u)}for(var m=Cu["import"]("resource://gre/modules/Services.jsm",{}).atob,d=m(images[s].qr),v=new Uint8Array(d.length),g=0,f=d.length;f>g;g++)v[g]=d.charCodeAt(g);Cu["import"]("resource://gre/modules/FileUtils.jsm"),c=FileUtils.getFile("TmpD",["wma.gif"]),c.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE,FileUtils.PERMS_FILE),Cu["import"]("resource://gre/modules/osfile.jsm"),OS.File.writeAtomic(c.path,v).then(function(){a()},function(e){i=e,a()})},exports.checkLicense=function(e,t){simpleStorage.storage.converter.license.status="unchecked",Request({url:"https://www.downloadhelper.net/license-check.json.php",content:{key:e,product:"converthelper"},onComplete:function(e){e.json.status&&(simpleStorage.storage.converter.license.status=e.json.status),e.json.name&&e.json.email&&e.json.key?merge(simpleStorage.storage.converter.license,{name:e.json.name,email:e.json.email,key:e.json.key,check:LicenseSign(e.json)}):(delete simpleStorage.storage.converter.license.name,delete simpleStorage.storage.converter.license.email,delete simpleStorage.storage.converter.license.key),simpleStorage.storage.converter.license.lastChecked=Date.now(),t&&t()}}).post()},exports.config=function(){return simpleStorage.storage.converter},exports.deleteRule=function(e){simpleStorage.storage.converter.rules.splice(e,1)};var defaultConfigs={"249a7d34-3640-4ac3-8300-13827811d2cf":{title:"MPEG (mpeg1+mp2)",ext:"mpg",params:{"c:a":"mp2",f:"mpeg",r:24,"c:v":"mpeg1video"},extra:"-mbd rd -trellis 2 -cmp 2 -subcmp 2 -g 100",audioonly:!1,readonly:!0},"6de4f5ce-8cfe-4f0f-8246-bacb7b0d7624":{title:"WMV 500Kb (Windows Media Player)",ext:"wmv",params:{"c:a":"wmav2",f:"asf","c:v":"wmv2","b:v":"500k"},extra:null,audioonly:!1,readonly:!0},"21a19146-e116-4460-8356-a8eab9cf61ce":{title:"WMV 1Mb (Windows Media Player)",ext:"wmv",params:{"c:a":"wmav2",f:"asf","c:v":"wmv2","b:v":"1000k"},extra:null,audioonly:!1,readonly:!0},"933b1b41-6862-4ce0-9605-10fa5e4b310c":{title:"WMV 2Mb (Windows Media Player)",ext:"wmv",params:{"c:a":"wmav2",f:"asf","c:v":"wmv2","b:v":"2000k"},extra:null,audioonly:!1,readonly:!0},"90195ab2-d891-443c-a164-8f0953ec8975":{title:"WMV 4Mb (Windows Media Player)",ext:"wmv",params:{"c:a":"wmav2",f:"asf","c:v":"wmv2","b:v":"4000k"},extra:null,audioonly:!1,readonly:!0},"3a4cc0a6-6eb0-4cff-90fb-fdf8eb6a9571":{title:"AVI 500Kb (mpeg4/mp3)",ext:"avi",params:{"c:a":"mp3",f:"avi","c:v":"mpeg4","b:v":"500k","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"ebdbb895-7a1e-43e2-bef4-be6e62cb8507":{title:"AVI 1Mb (mpeg4/mp3)",ext:"avi",params:{"c:a":"mp3",f:"avi","c:v":"mpeg4","b:v":"1000k","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"0b6280d3-f8f2-4cb6-8235-a5a4b91488f7":{title:"AVI 2Mb (mpeg4/mp3)",ext:"avi",params:{"c:a":"mp3",f:"avi","c:v":"mpeg4","b:v":"2000k","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"9ea8a22b-5738-4d0f-8494-3037ec568191":{title:"AVI 4Mb (mpeg4/mp3)",ext:"avi",params:{"c:a":"mp3",f:"avi","c:v":"mpeg4","b:a":"4000k","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"4174b9dd-c2a0-409d-801d-c84f96be0b76":{title:"MP3",ext:"mp3",params:{"b:a":"128k","c:a":"mp3",f:"mp3"},extra:null,audioonly:!0,readonly:!0},"05cb6b27-9167-4d83-833d-218a107d0376":{title:"MP3 HQ",ext:"mp3",params:{"b:a":"256k","c:a":"mp3",f:"mp3"},extra:null,audioonly:!0,readonly:!0},"69397f64-54f2-4ee4-b47a-b4fc42ee2ec1":{title:"MP4 500Kb",ext:"mp4",params:{"c:v":"mpeg4","c:a":"aac",f:"mp4","b:v":"500k","b:a":"128k",ac:2},extra:"-mbd rd -flags +mv4+aic -trellis 2 -cmp 2 -subcmp 2 -g 300",audioonly:!1,readonly:!0},"16044db3-3b75-4155-b549-c0ba19c18887":{title:"MP4 1Mb",ext:"mp4",params:{"c:v":"mpeg4","c:a":"aac",f:"mp4","b:v":"1000k","b:a":"128k",ac:2},extra:"-mbd rd -flags +mv4+aic -trellis 2 -cmp 2 -subcmp 2 -g 300",audioonly:!1,readonly:!0},"b5535083-bf16-4ae0-a21f-7c637ce0617f":{title:"MP4 2Mb",ext:"mp4",params:{"c:v":"mpeg4","c:a":"aac",f:"mp4","b:v":"2000k","b:a":"128k",ac:2},extra:"-mbd rd -flags +mv4+aic -trellis 2 -cmp 2 -subcmp 2 -g 300",audioonly:!1,readonly:!0},"dfbed97f-46c9-4db8-b5d1-4d19901bc236":{title:"MP4 4Mb",ext:"mp4",params:{"c:v":"mpeg4","c:a":"aac",f:"mp4","b:v":"4000k","b:a":"128k",ac:2},extra:"-mbd rd -flags +mv4+aic -trellis 2 -cmp 2 -subcmp 2 -g 300",audioonly:!1,readonly:!0},"912806c1-6c43-44ad-ac6e-05f105bade55":{title:"iPhone",ext:"m4v",params:{"c:v":"mpeg4","c:a":"aac",s:"480x320","b:v":"800k",f:"mp4",r:"24","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"2416dcbf-146d-4ca4-b948-f6f702fb043c":{title:"iPod",ext:"m4v",params:{"c:v":"mpeg4","c:a":"aac",s:"320x240","b:v":"500k",f:"mp4",r:"24","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"42fb9cf9-94f9-45c1-954f-1c5879f3d372":{title:"Galaxy Tab",ext:"mp4",params:{"c:a":"aac","b:a":"160k",ac:"2","c:v":"h264",f:"mp4"},extra:"-crf 22",audioonly:!1,readonly:!0},"edf545c2-88fc-4354-b91d-83e2f31d3c14":{title:"MOV (QuickTime player)",ext:"mov",params:{f:"mov","c:v":"h264",preset:"fast","profile:v":"baseline","c:a":"aac","b:a":"128k"},extra:null,audioonly:!1,readonly:!0},"f31ac68e-db3b-4b17-95d7-04456cbc3c26":{title:"Mobile 3GP (Qcif)",ext:"3gp",params:{f:"3gp","c:v":"h263","c:a":"aac","b:a":"12k",s:"176x144","b:v":"64k",ar:"8000",r:"24"},extra:null,audioonly:!1,readonly:!0},"85cd71a0-fb61-45a4-9fed-6f2e6e405bc3":{title:"MPEG-2 DVD (PAL)",ext:"mpeg",params:{f:"mpeg2video",target:"pal-dvd"},extra:null,audioonly:!1,readonly:!0},"47b9b2eb-8fd4-4e10-8993-f7d467ed1928":{title:"MPEG-2 DVD (NTSC)",ext:"mpeg",params:{f:"mpeg2video",target:"ntsc-dvd"},extra:null,audioonly:!1,readonly:!0}};if(exports.resetConfigs=function(){simpleStorage.storage.converter.configs=defaultConfigs},exports.showConfigs=function(){console.info("configs",JSON.stringify(simpleStorage.storage.converter.configs,null,4))},exports.resetRules=function(){simpleStorage.storage.converter.rules=[]},exports.setConfigs=function(e){e&&(simpleStorage.storage.converter.configs=e)},exports.updateRules=function(e){simpleStorage.storage.converter.rules=e},exports.updateHit=function(e){if(void 0===e.data._convert&&simpleStorage.storage.converter.rules)for(var t=0;t<simpleStorage.storage.converter.rules.length;t++){var r=simpleStorage.storage.converter.rules[t];if(!(r.convert&&!simpleStorage.storage.converter.configs[r.config]||r.ext&&e.data.extension&&r.ext!=e.data.extension)){if(r.domain){var a=!1;try{var o=new RegExp("https?://[^/]*\\b"+r.domain.replace(/\./,"\\."));e.data.url&&o.test(e.data.url)?a=!0:!a&&e.data.topUrl&&o.test(e.data.topUrl)?a=!0:!a&&e.data.videoUrl&&o.test(e.data.videoUrl)?a=!0:!a&&e.data.audioUrl&&o.test(e.data.audioUrl)&&(a=!0)}catch(s){}if(!a)continue}if(r.convert)if("ready"!=simpleStorage.storage.converter.status)log.error(_("rule-converter-unavail",e.data.title)),e.data._convert=null;else{var n=simpleStorage.storage.converter.configs[r.config];n&&(e.data.extension&&(e.data.originalExt=e.data.extension),e.data.extension=n.ext||n.params.f||e.data.extension,e.data._convert=n)}break}}},exports.status=function(e){"ready"==simpleStorage.storage.converter.status?e():exports.check(e)},exports.convert=function(e,t,r,a){var o=["-y","-i",e.source];e.wm&&e.wm.qr&&!e.config.audioonly&&(o=o.concat(["-i",e.wm.qr,"-filter_complex","[0:v][1:v] overlay="+e.wm.x+":"+e.wm.y]));var s=o.concat([]);for(var n in e.config.params){var i=e.config.params[n];null!==i&&("string"!=typeof i||i.length>0)&&(o.push("-"+n),o.push(""+i))}if(e.config.extra){var c=/^\s*(.*?)\s*$/.exec(e.config.extra)[1].split(/\s+/);c.forEach(function(e){o.push(e)})}if(e.config.audioonly&&o.push("-vn"),o=o.concat(["-threads",simplePrefs.prefs["converter-threads"],"-strict","experimental"]),e.config.twopasses){o=["-pass","2"].concat(o),o.push(e.target);var l=simplePrefs.prefs["conversion-no-pass1-params"].split(",");for(var n in e.config.params){var i=e.config.params[n];null!==i&&("string"!=typeof i||i.length>0)&&l.indexOf(n)<0&&(s.push("-"+n),s.push(""+i))}Cu["import"]("resource://gre/modules/FileUtils.jsm");var p=FileUtils.getFile("TmpD",["vdh"]);s=s.concat(["-pass","1","-passlogfile:v",p.path,"-an","-strict","experimental"]),s.push("winnt"==system.platform?"NUL":"/dev/null"),exports.multiExecute([s,o],function(e,a,o){0==e?t():r({text:_("failed-conversion"),details:o})},a)}else o.push(e.target),exports.execute(o,function(e,a,o){0==e?t():r({text:_("failed-conversion"),details:o})},a)},exports.doConvertLocal=function(e){function t(){panels.togglePanel("dlconv",{contentURL:"dlconvPanel.html",top:10,closeTimeout:0,jsFiles:["lib/jquery.min.js","lib/bootstrap/bootstrap.min.js","dlconvPanel.js"],onShow:function(t){var r=exports.config();t.port.emit("contentMessage",{type:"set",name:"formats",value:r.formats}),t.port.emit("contentMessage",{type:"set",name:"codecs",value:r.codecs}),t.port.emit("contentMessage",{type:"set",name:"targets",value:r.targets}),t.port.emit("contentMessage",{type:"set",name:"configs",value:r.configs}),t.port.emit("contentMessage",{type:"set",name:"hasConvertButton",value:!0}),t.port.emit("contentMessage",{type:"set",name:"panelTitle",value:_("convert-local-files")}),t.port.emit("contentMessage",{type:"set",name:"files",value:e}),t.port.emit("contentMessage",{type:"set",name:"transientStorageDirectory",value:require("actions").transientStorageDirectory()}),t.port.emit("contentMessage",{type:"set",name:"renameCheckbox",value:!1})},onMessage:function(r,a){switch(r.type){case"setConfigs":exports.setConfigs(r.configs);break;case"resetConfigs":exports.resetConfigs(r.configs),a.port.emit("contentMessage",{type:"set",name:"converter",value:exports.config()});break;case"showConfigs":exports.showConfigs(r.configs);break;case"changeStorageDirectory":require("actions").changeStorageDirectory(require("sdk/private-browsing").isPrivate(window),t);break;case"conversionHelp":a.hide(),require("sdk/tabs").open({url:"http://www.downloadhelper.net/conversion-manual3.php"});break;case"convert":a.hide();var o=exports.config().configs[r.config];o&&BatchConvert(e,o)}}})}t()},exports.batchConvert=function(e,t){BatchConvert(e,t)},exports.convertLocal=function(){if("ready"!=simpleStorage.storage.converter.status)return void alerts.alert({title:_("converter-required"),text:_("converter-needed-local"),action:{text:_("install-converter"),click:"post('installConverter')"},onMessage:function(e,t){switch(e.type){case"installConverter":t.hide(),require("sdk/tabs").open({url:"http://www.downloadhelper.net/install-converter3.php"})}}});var e=require("sdk/windows").browserWindows.activeWindow,t=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator),r=t.getMostRecentWindow("navigator:browser"),a=Cc["@mozilla.org/filepicker;1"].createInstance(Ci.nsIFilePicker);a.init(r,_("files-to-convert"),Ci.nsIFilePicker.modeOpenMultiple);var o=require("actions").getDownloadDirectory(require("sdk/private-browsing").isPrivate(r));a.displayDirectory=o,a.appendFilter("Video","*.flv; *.FLV; *.avi; *.AVI; *.mpeg; *.MPEG; *.mpg; *.MPG; *.wmv; *.WMV; *.rm; *.RM; *.mov; *.MOV; *.mp4; *.MP4"),a.appendFilters(Ci.nsIFilePicker.filterAll);var s=null;a.open({done:function(t){if(t!=Ci.nsIFilePicker.returnCancel){s=[];for(var r=a.files;r.hasMoreElements();)s.push(r.getNext().QueryInterface(Ci.nsIFile).path);e.activate(),exports.doConvertLocal(s)}}})},exports.convertInput=function(e,t){var r=[],a=[],o=["-y","-f","rawvideo","-s",e.width+"x"+e.height,"-pix_fmt","rgba","-i","tcp://localhost:"+e.port+"?listen"];simplePrefs.prefs["scrap.extra-args"].split(/ +/).forEach(function(e){e.length&&o.push(e)}),o=o.concat(["-r",""+e.rate,"-f","mp4",e.outputFilePath]),simplePrefs.prefs["converter-log-calls"]&&log.log({text:"Converter call",details:JSON.stringify(o,null,4)});var s={stdio:["pipe","ignore","ignore"]},n=childProcess.spawn(simplePrefs.prefs["converter-path"],o,s);return n.stdout.on("data",function(e){r.push(e)}),n.stderr.on("data",function(e){a.push(e)}),n.on("close",function(e){t(e,r.join(""),a.join(""))}),n},simpleStorage.storage.converter){simpleStorage.storage.converter.configs||exports.resetConfigs();for(var confId in defaultConfigs)simpleStorage.storage.converter.configs[confId]=defaultConfigs[confId]}else simpleStorage.storage.converter={status:"unchecked"},exports.resetConfigs();simpleStorage.storage.converter.license||(simpleStorage.storage.converter.license={status:"unchecked"}),simpleStorage.storage.converter.rules||(simpleStorage.storage.converter.rules=[]),"linux"==system.platform?simpleStorage.storage.converter.license.status="unneeded":"unneeded"==simpleStorage.storage.converter.license.status&&(simpleStorage.storage.converter.license.status="unchecked"),"winnt"!=system.platform||simpleStorage.storage.converter.licenseMigrated?"accepted"==simpleStorage.storage.converter.license.status&&LicenseSign(simpleStorage.storage.converter.license)!=simpleStorage.storage.converter.license.check&&exports.checkLicense(simpleStorage.storage.converter.license.key):(simpleStorage.storage.converter.licenseMigrated=!0,WindowsMigrateLicense(),simpleStorage.storage.converter.license.key&&exports.checkLicense(simpleStorage.storage.converter.license.key));var images={240:{x:7,y:7,qr:"R0lGODlhHwAfAKEAAAAAAP///wAAAAAAACH5BAEKAAIALAAAAAAfAB8AAAKejI+pi+DvwksTQgNUZk1jWUlHFWXXZoYhWLLmd7KiK8a1etFpO3cgDKRgLLwXypXj/DY/JTLom9lKpMho0utRt0xatjt8eWDg6PF62nXX2+xIar3CSeG4ln4UL4dvyzOed6Y22CTVtNbBpEjkp5T29gHJyIY4eBYFGanVt4KGBsjZQkk1Ryba8IhipXbjN4nlVqPpc4nUKWua5LSrUAAAOw=="},481:{x:10,y:10,qr:"R0lGODlhXQBdAKEAAAAAAP///wAAAAAAACH5BAEKAAIALAAAAABdAF0AAAL+jI+py+0Po5y02ouz3gr4D4bih4iWeYzquqxuWMIVarw20N5uDJ5yrWN1PD4cJ0KaEYdGSvL4eE6kqaXTCm1Qkdhqc9rNMou5787LK4940rYQ+EV713K4mhbAu1Xp8VyPtZX3NthTV0hn5weXWMgWGIYIaEYouNd4CRnHOPn447go+ZlJuSlqqMg5GkmKCqral3CWerpX5unaive3WorJqvnrS8ibG9wZOvta+1ls66x5q2Rq+YT6fEUdGQWsbXUdPS2dPc42dyjI7U0Wes6Ivu1QHSTsjmivS39Hjw3+bX2MXzeB/QD+O4iLnxh54bTEWwhxWbpDESvSmkjLYkX+bAwwitFRziOTTa6gldrHJ9lDNSNRcjRZ8uLKlrLm1RtpMCUzUy4HMnyY6IVJCcrssXT4Q6iqmB2JvUPKE8LNC/NwaZzKruawmRqwilPZbKFXcmCZYmBq8yfIpQm5mmv3tGmQYm2jyl1H8+4NukO52N3pKVZWiU6X9dwq+KtMnYlx9npJdnEjio6NWc7AsajUnIdbwdwFV10TtDasLtWsddpom5VoKPypNiiye3FjYp2s1/Vsf6vD3AbdmW8q3kbZwgsb3PhwznGFE0Z+XOlO3lXzksZ7Wndp5Y1pe++eL+le7pS9Xye6ErLhygQZw36fMb7W9tLV2S/vkf54i7PpcK9PDd9Gb/iXX3puYTYgcAX+JdIG/SloIIMDtRcbcMfVRaB+dtUHFoYQ6lchdIt5iFyDAIIBVIRHyTWYXxuqmFc56P0VY2jgYWRid2oFKGNzZc0m2odrzRegMiai9hqRSNWlI3sTbqcki32NCNWDvTD545XlfXbQZVMKZmRDneWUWWHhgZkilL+5JxmQFHIpUJGtbTXkdG9Kmd1JcE6ioYj/3bfcgVGiSaN8gL5i1mbdNHkiirEkKlpIbuV4oY8oYvenk3NtWdsW1OmjaZ04MveWnWZqyChxUdKnUauuvgprrLLOSqtGBQAAOw=="},721:{x:15,y:15,qr:"R0lGODlhugC6AKEAAAAAAP///wAAAAAAACH5BAEKAAIALAAAAAC6ALoAAAL+jI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8fyTNe2CeT6zvf+D9QtgjscMTc8Kpc/CfMJTR6NUwX0qnRit01rtrSUcsfICPkMEAepRDX6qn1v3V1S2CvHxvNRfBv8lcCnZzbYJxg4codoyLQnBMhz0+HDBglRGVk0uZFp1/NY9inJqeGpCFpIOrpZinEqAtsgC0LrGpqmeflg69F7y5vKuuvwy2EMzIBsKhy8ijDnR2ywHBDN+Ic9bU2oLercCt0t/nxQfU2enb6Nbt5c/E497l4uX688b69OH87/RIeLTiJ/3wjmwpSPWxVvB9c5klZwVjyFhxw2NIhroL7+NRAvbnzIMGBHjRTZTRS40CKtlQnPTWz30WPJiPjgjHyJ02ZIVf1ikmSZEiPCljkrCh3ac+YiiyjvLeMC8Oa+mCIZ/izKcSc4o1SlZmXK06ROsFax0vT69ajKoF2RiuWqtGnSpzDjoq1DdivNukCn2tULMq/Bq/eilvXbN21beESdNk5qeC1is2PC/usoF0hkxnMfvz1jObDawWz/As6Md7TPundTLyY9uTDm1pRRi645VrVSwpBnH1ZsGnZu3HAT3w4u0fFw5LtZ/wZufKnuzSFcyvZGnXm1Vyd9o7ouOPnnvbV1nfUeq7tWvdmjWzq/Pj346RDblx8GP3wt9fr+3dhX3hsl/NEn4HyviUcegOPJ9IF1AR4z4IHEyeQeetVF2FwjFcb30X+daUiSbSB6OB6JCYLol4gamkihgicuiCKGMZa2oUMsqthIRjMuaOKNtK0Y2o48WjiTj8/FqKOQRtpIZHRC5pfMkhRsF2WV+lHZn5VaSjkBllsmU+OUGH5ZZZhdjkkmmPdV4GWapZhZlZs/ltYkmhY4uA2OQ7pFRmjZNShjoMvh2SefLRqYAaEMzrknYFAZ+qcvgj4onGZE6glcnYhyh6iivOXJaKYcMgdop5NeNiqmlp52qaSmvlrcqatKBp1zd9qaJasXSLdabMtx+murut5Ko2eoQpj+UKTDsvnpcY8WGGyqkAJb66C4ipmssJyBaqiTxWZLbLS5bgslgrNW6lqGKe56rYR+ttDsovjJe2WIVsYLr6yHrlvmt5ReCCuMdk6CLwuK2ianui+Wu1/AC6erZcErHNxawhKrQPGR9MJAaJzM5lhxqBt3IqvH2BqCsMgndPwuuyBrrOrKJbcc7iApazzwx/8WSbPONoeM86bUMqxvokDCrPJ7I/M8rcsoA03ruSQLHfSHvnL7ndUP8zrh0jFDTWDWJYq8dJu9Vns1w6VqvS9cyjrqL9pYy8e2qmXnfLbUCj+cr4t2m3ymtXGr7WrdZMtcj6cwcT3i0F47ri26tzH+fnTNhDs9jeL5UP6y5Y9jHpHmw3H+NOifex553seq3jYfRlONurRVT0X6z6Yj3pPoXNXuOuSO88p7662/Lbl/YE89+sW6rUluupSZ3TXwykvIvLnOuwjx7xoF32Pqew9/PDObT68d9kkajnThu5NvHPGsG58+tOsPLjz84xZfX/iAy2G3tztnHLYAUu8N/Xuew+6WuKL1jHXxelbUEPi/eACweQVkW2XuAjjqTNB6FRSYsTbYNe+BkH9k89/c3GUhELKILyQ8UgZTqED1XW55MfTZk0CzthNyKYSmu6EDkbUzTUUQdgz0IZ18FzvZ3S96RhSXDU83wANqr4mrQ57+DoWoQ7NREYcyhGL5pNjDLR4nYizk1xIn9LogvqmMolIiudJ4xTV+sIY2hOMMb/BD1b2QT3b0Yg3yuLc9sgeJaQKkvdxorj5ajI16cx8aCdm8G/bxkMuKYungpqQptrGSX7xkJJ80ySM2rV6d+2Qmw2hGCmKxd90CpSYbucBO2g6TOwplKjm4yjycb0a23KQqR9W4UdItjqBT5NAE+Uux3fFkyySVZZCJy3nhrpnQoyMzmxnLhhHzjPZL5hOVNk0/VhOMtzOPH0NhzGJmc53yw+YzIXlNaPJwdnzL4RhLKEpu5pJ8vYQlPe+JyHk+EE79zN4/uebIFdJPm1VkIhr+5KnQtJ0zaa18KDs5yUh3/nOXFxTmNYXHPrx9r4Fm+VssM1q/VzqrWSb16EjN570Obq2khzvpBxOKTwu2r6YuRSlOD2pAv/EUozeNaU49iL6BjrCoAZUpSGl60P0xVakEPCov4flSCzo1eGI0KFEFp9PKSa6r6aSqVq260q7m05tFPCtQ56hWIlqyoSac5VjFWNa7utWsXORrE/MKsL0KkKFEg2kXwZnLvg2xUUDc5kd3iFg+GtWl9kxpUw/7zstSFrPAFClWu4nCckozsQabmWY5WVnImhOdk6XlVU9LEEfWlZWuRVJrYyvCoHrSepK8bYdyi71g1hZFP2VSQGc4q8sguRK2vz2ubu3K2+XqEzvADWspo3vK6Rr3jMhtYcK+C97wine85C2vec+L3vSqd73sbe96CwAAOw=="},1081:{x:25,y:25,qr:"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"}};