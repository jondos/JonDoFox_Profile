/* Copyright (C) 2006-2015 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function UpdateExtensions(){extensions={},simplePrefs.prefs["media-extensions"].split("|").forEach(function(e){extensions[e]=1})}function UpdateFilterOut(){filterOutRE=null;var e=simplePrefs.prefs["network-filter-out"];if(e)try{filterOutRE=new RegExp(e)}catch(t){}}function GetRespHeader(e,t){var r=null;try{r=e.getResponseHeader(t)}catch(n){}return r}function GetReqHeader(e,t){var r=null;try{r=e.getRequestHeader(t)}catch(n){}return r}function WorkerForContent(e,t,r,n,i,s,a,o){var l=Worker({window:e.top?e.top:e,contentScriptFile:self.data.url("pagedata-content.js")});l.port.on("pageurl",function(){try{l.port.emit("get-title",{specs:[s.spec]})}catch(e){if(l.tab){var r=/([^\/]*?)(?:\?.*)?$/.exec(l.tab.url)[1];t.title=r||_("media"),t.pageUrl=t.url,t.topUrl=t.pageUrl,t.isPrivate=privateBrowsing.isPrivate(l),NotifyHit(t)}l.detach()}}),l.port.on("pagedata",function(e){if(simplePrefs.prefs["smartnamer.enabled"]&&(t.title=e.title||_("media")),t.pageUrl=e.url,t.topUrl=a,t.isPrivate=privateBrowsing.isPrivate(l),l.tab){var s=viewFor(l.tab);try{s.getAttribute("remote")||(t.thumbnail=l.tab.getThumbnail())}catch(p){}t.topUrl=l.tab.url}r?tbvws.handleNetworkHook(r,t):t.extension&&"mp2t"==o?require("chunks").newChunk(t):n||i?require("f4f").firstFragment(t):NotifyHit(t),l.detach()})}function ListenResponse(e){var t=e.subject.QueryInterface(Ci.nsIHttpChannel),r=tbvws.networkHook(t.name),n=!!r,i=GetRespHeader(t,"Content-Length");if(n||"0"!==i){var s=null,a=GetRespHeader(t,"Content-Range");if(a){var o=RANGE_PATTERN.exec(a);o&&(s=o[1])}s||(s=i),s=parseInt(s);var l=EXT_PATTERN.exec(t.name);l&&!extensions[l[1]]&&(l=null);var p=F4F_PATTERN.test(t.name),u=CFLV_PATTERN.test(t.name);l&&"f4f"==l[1].toLowerCase()&&p&&(n=!0),l&&"flv"==l[1].toLowerCase()&&u&&(n=!0);var f=GetRespHeader(t,"Content-Type"),c=TYPE_PATTERN.exec(f);if(c&&"f4f"==c[2].toLowerCase()&&p&&(n=!0),c&&"flv"==c[2].toLowerCase()&&u&&(n=!0),!(!n&&filterOutRE&&filterOutRE.test(t.name)||!n&&!c&&isNaN(s)&&!l||!(n||c||l)&&(0==simplePrefs.prefs["mediaweight-threshold"]||s<simplePrefs.prefs["mediaweight-threshold"])||!n&&!isNaN(s)&&s<simplePrefs.prefs["mediaweight-min-size"]||!n&&filterOutRE&&filterOutRE.test(t.name)||!n&&c&&"ms-asf"==c[2]&&simplePrefs.prefs["exclude-msasf"])){var m={id:"network-probe:"+utils.md5(t.name),url:t.name},d=GetRespHeader(t,"Content-Disposition");if(d){var v=CDFNAME_PATTERN.exec(d);v&&v[1]&&(m.headerFilename=v[1])}var R={},h={visitHeader:function(e,t){R[e]=t}};if(t.visitRequestHeaders(h),simplePrefs.prefs["remove-media-no-cache"]){var g=GetRespHeader(t,"Pragma");"no-cache"==g&&t.setResponseHeader("Pragma",null,!1);var w=GetRespHeader(t,"Cache-Control");w&&t.setResponseHeader("Cache-Control",null,!1);var E=GetRespHeader(t,"Expires");E&&t.setResponseHeader("Expires",null,!1)}for(var x in R){m.headers=R;break}var C=NAME_PATTERN.exec(t.name);if(C&&(m.urlFilename=C[1]),m.title=m.headerFilename||m.urlFilename||_("media"),l?(m.type="video",m.extension=l[1]):c&&(m.type=c[1],m.extension=c[2]),"f4m"!=m.extension&&("f4f"!=m.extension||p)){var T=GetReqHeader(t,"referer");T&&(m.referrer=T);var s=null,a=GetRespHeader(t,"Content-Range");if(a){var o=RANGE_PATTERN.exec(a);o&&(s=o[1])}s||(s=i),s=parseInt(s),isNaN(s)||(m.length=s);var k=null;if(t.loadGroup&&t.loadGroup.notificationCallbacks)try{var N=t.loadGroup.notificationCallbacks.QueryInterface(Ci.nsIInterfaceRequestor);k=N.getInterface(Ci.nsIDOMWindow)}catch(P){}if(null==k&&t.notificationCallbacks)try{var b=t.notificationCallbacks.getInterface(Ci.nsILoadContext);b.topFrameElement&&(k=b.topFrameElement._contentWindow||null)}catch(P){}if(null==k&&t.notificationCallbacks)try{var F=t.notificationCallbacks.QueryInterface(Ci.nsIInterfaceRequestor);k=F.getInterface(Ci.nsIDOMWindow)}catch(P){}k&&timers.setTimeout(function(){var e=!1;try{e=/^(audio|video)/.test(k.document.contentType)}catch(t){}var n=k.top?k.top.document.URL:k.document.URL,i=m.extension?m.extension.toLowerCase():"",s=smartNames.specForUrl(n);if(!s.contentNeeded||e){m.pageUrl=k.document.URL,m.topUrl=k.top.document.URL,"obfuscated"==s.spec.mode&&(m.title=smartNames.getObfuscated(n)),m.isPrivate=privateBrowsing.isPrivate(k);for(var a in tabs){var o=tabs[a];if(o.url==n){var l=viewFor(o);try{l.getAttribute("remote")||(m.thumbnail=o.getThumbnail())}catch(t){}}}m.extension&&"mp2t"==i?require("chunks").newChunk(m):p||u?require("f4f").firstFragment(m):NotifyHit(m)}else s.spec.delay?timers.setTimeout(function(){WorkerForContent(k,m,r,p,u,s,n,i)},s.spec.delay):WorkerForContent(k,m,r,p,u,s,n,i)},0)}}}}function NotifyHit(e){listeners.forEach(function(t){t(e)})}function DoNothing(){}function StartStop(e){var t=simplePrefs.prefs["network-probe"];t&&!e||!running?t&&!running&&(running=!0,UpdateFilterOut(),events.on("http-on-examine-response",ListenResponse),events.on("http-on-examine-cached-response",ListenResponse)):(running=!1,events.off("http-on-examine-response",ListenResponse),events.off("http-on-examine-cached-response",ListenResponse))}const simplePrefs=require("sdk/simple-prefs"),events=require("sdk/system/events"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,windowUtils=require("sdk/window/utils"),once=require("sdk/event/core").once,self=require("sdk/self"),_=require("sdk/l10n").get,tabs=require("sdk/tabs"),utils=require("utils"),privateBrowsing=require("sdk/private-browsing"),Worker=require("sdk/content/worker").Worker,tbvws=require("tbvws"),timers=require("sdk/timers"),viewFor=require("sdk/view/core").viewFor,smartNames=require("smartnames"),TYPE_PATTERN=new RegExp("^(audio|video)/(?:x-)?([^; ]+)"),RANGE_PATTERN=new RegExp("^bytes [0-9]+-[0-9]+/([0-9]+)$"),EXT_PATTERN=new RegExp("\\.([a-z0-9]{1,5})(?:\\?|#|$)","i"),NAME_PATTERN=new RegExp("/([^/]+?)(?:\\.([a-z0-9]{1,5}))?(?:\\?|#|$)","i"),CDFNAME_PATTERN=new RegExp('filename\\s*=\\s*"\\s*([^"]+?)\\s*"'),F4F_PATTERN=new RegExp("Seg1-Frag1(?:\\?|$)"),CFLV_PATTERN=new RegExp("frag\\(1\\)");var running=!1,listeners=[],extensions={};UpdateExtensions(),simplePrefs.on("media-extensions",UpdateExtensions);var filterOutRE=null;simplePrefs.on("network-filter-out",UpdateFilterOut),simplePrefs.on("network-probe",function(){StartStop()}),StartStop(),exports.addListener=function(e){listeners.push(e)},exports.removeListener=function(e){var t=listeners.indexOf(e);t>=0&&listeners.splice(t,1)},require("sdk/system/unload").when(function(){StartStop(!0)});