/* Copyright (C) 2006-2015 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function DecodeVideoData(e,t){var n=null;try{n=t[1].data.swfcfg.args}catch(r){}if(n){var o=[],i={videoId:e.videoId,title:n.title||_("video"),topUrl:e.topUrl,pageUrl:e.pageUrl,from:"tbvws",maxVariants:e.maxVariants,autoExec:e.autoExec,isPrivate:e.isPrivate};n.thumbnail_url&&(i.thumbnail=n.thumbnail_url),n.pageUrl&&(i.pageUrl=n.pageUrl),["url_encoded_fmt_stream_map","adaptive_fmts"].forEach(function(e){n[e]&&n[e].split(",").forEach(function(e){var t={};e.split("&").forEach(function(e){var n=PARAM_PATTERN.exec(e);n&&(t[decodeURIComponent(n[1])]=decodeURIComponent(n[2]))}),t.url&&o.push(t)})});var a=variants.getHitsFromVariants(i,o);a.forEach(function(e){listeners.forEach(function(t){t(e)})})}}function GetVideoMeta(e){Request({url:e.baseUrl+"/watch?v="+e.videoId+"&spf=navigate",onComplete:function(t){simplePrefs.prefs["write-video-data-file"]&&utils.saveStringToFile("tbvws-"+e.videoId+".json",JSON.stringify(t.json,null,4)),DecodeVideoData(e,t.json)},headers:{referer:e.baseUrl+"/results?search_query="+encodeURIComponent(e.title)}}).get()}function BulkDownload(e,t){var n=selectedIds[e];if(n&&!(n.count<1)||t){var r=/^(https?:\/\/[^\/]+)/.exec(e)[1],o=[];if(n&&(o=Object.keys(n.ids)),t){var i=/\bv=([^&]+)/.exec(t)[1];n&&n.ids[i]||o.push(i)}o.forEach(function(e){GetVideoMeta({baseUrl:r,videoId:e,title:e,topUrl:r+"/watch?v="+e,maxVariants:1,autoExec:"quickdownload"})})}}function UpdateContextMenus(){menus.appendMenuItem(merge({},baseContextMenu,{label:_("download-selected-links"),context:contextMenu.PredicateContext(function(e){var t=e.documentURL,n=e.linkURL?1:0;return t&&selectedIds[t]&&(n+=selectedIds[t].count),n>1})})),menus.appendMenuItem(merge({},baseContextMenu,{label:_("download-selected-link"),context:contextMenu.PredicateContext(function(e){var t=e.documentURL,n=e.linkURL?1:0;return t&&selectedIds[t]&&(n+=selectedIds[t].count),1==n})}))}function PurgeHookedVideos(){var e=Date.now();for(var t in hookedVideos)e>hookedVideos[t].expire&&delete hookedVideos[t]}const self=require("sdk/self"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,pageMod=require("sdk/page-mod"),Request=require("sdk/request").Request,simplePrefs=require("sdk/simple-prefs"),merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,privateBrowsing=require("sdk/private-browsing"),contextMenu=require("sdk/context-menu"),timers=require("sdk/timers"),variants=require("variants"),utils=require("utils");var menus=require("menus"),OS=null,encoder=null,listeners=[];const PARAM_PATTERN=new RegExp("^(.*?)=(.*)$"),TYPE_PATTERN=new RegExp("^([^/;]+)/(?:x-)?([^/;]+)"),PM_PATTERN=new RegExp("^https?://([^/]*.)?youtube(.co)?.([^./]+)/.*"),SIGN_PATTERN=new RegExp("[?&]signature="),ITAG_PATTERN=new RegExp("[?&]itag=([^&]+)"),ID_PATTERN=new RegExp("[?&]id=([^&]+)"),HV_PATTERN=new RegExp("^https?://([^/]*.)?googlevideo\\.");var hookedVideos={};exports.networkHook=function(e){if(!HV_PATTERN.test(e))return null;if(!SIGN_PATTERN.test(e))return null;var t=ITAG_PATTERN.exec(e);if(!t)return null;var n=t[1];if(t=ID_PATTERN.exec(e),!t)return null;var r=t[1],o=hookedVideos[r];if(!o){var i=variants.hasAudioVideo("tbvws:"+n);o=hookedVideos[r]={variants:{},audio:i.audio,video:i.video,expire:Date.now()+6e4}}return o.variants[n]?null:{id:r,itag:n,url:e,video:o}},exports.handleNetworkHook=function(e,t){var n=e.url,r=e.id,o=e.itag,i=e.video;if(m=/^.*?\?(.*)$/.exec(n),!m)return null;var a={};if(m[1].split("&").forEach(function(e){var t=/^(.*?)=(.*)$/.exec(e);t&&(a[t[1]]=t[2])}),i.variants[o]={url:n.replace(/(\?|&)range=[0-9]+\-[0-9]+&?/,"$1"),itag:o,type:decodeURIComponent(a.mime),clen:a.clen},/^audio/.test(a.mime)&&(i.audio=!0),/^video/.test(a.mime)&&(i.video=!0),i.audio&&i.video){var s=[];for(var d in i.variants)s.push(i.variants[d]);var u=variants.getHitsFromVariants({title:t.title,from:"tbvws",videoId:r,topUrl:t.topUrl,pageUrl:t.pageUrl,duration:a.dur?Math.round(a.dur):void 0},s,{audioAndVideo:!0,keepProtected:!0}),l=require("converter").config();u.forEach(function(e){e._priorityClass="ready"!=l.status&&e.adp?-1:1,listeners.forEach(function(t){t(e)})})}};var selectedIds={};pageMod.PageMod({include:PM_PATTERN,contentScriptFile:self.data.url("tbvws-content.js"),contentScriptWhen:"end",onAttach:function(e){var t=null;e.port.on("detected-video",function(t){t.hasVideo&&(t.topUrl=e.tab.url,t.isPrivate=privateBrowsing.isPrivate(e),GetVideoMeta(t))}),e.port.on("selected-ids",function(n){t=e.tab.url,n.count>0?selectedIds[e.tab.url]={ids:n.ids,count:n.count}:delete selectedIds[e.tab.url]}),e.on("detach",function(){t&&delete selectedIds[t]})}}),exports.addListener=function(e){listeners.push(e)},exports.removeListener=function(e){var t=listeners.indexOf(e);t>=0&&listeners.splice(t,1)};var baseContextMenu={contentScript:'var contextHref = null;self.on("click", function() {  self.postMessage({ type: "click", url: window.location.href, contextHref: contextHref });});self.on("context",function(node) {  contextHref = null;  while(node && node.nodeType==Node.ELEMENT_NODE) {    if(node.tagName=="A") {      var href = node.getAttribute("href");      if(href && href.length>0 && /\\bv=[^&]+/.test(href))        contextHref = href;      break;    }    node = node.parentNode;  }  return true;});',onMessage:function(e){"click"==e.type&&BulkDownload(e.url,e.contextHref)}};UpdateContextMenus(),simplePrefs.on("context-menu",function(){timers.setTimeout(UpdateContextMenus,10)});var purgeTimer=timers.setInterval(PurgeHookedVideos,6e4);require("sdk/system/unload").when(function(){timers.clearInterval(purgeTimer)});