#!/bin/bash

## Copyright (c) JonDos GmbH
##
## All rights reserved.
## 
## Redistribution and use in source and binary forms, with or without modification, 
## are permitted provided that the following conditions are met:
## 
##     * Redistributions of source code must retain the above copyright notice, this list 
## 	 of conditions and the following disclaimer.
##     * Redistributions in binary form must reproduce the above copyright notice,
##       this list of conditions and the following disclaimer in the documentation and/or
##       other materials provided with the distribution.
##     * Neither the name of the University of Technology Dresden, Germany, nor the name of
##       the JonDos GmbH, nor the names of their contributors may be used to endorse or
##       promote products derived from this software without specific prior written permission.
## 
## THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
## "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
## LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
## A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR
## CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
## EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
## PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
## PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
## LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
## NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
## SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
##    
##   JonDoFox start script for Debian/Ubuntu/Mint
##   2010 by JonDos GmbH (info@jondos.de) 
##


if [ ! -e $HOME/.mozilla/firefox/profiles.ini ]; then
    if test "X$KDE_FULL_SESSION" = "Xtrue" ; then
        kdialog --error 'No profiles for Firefox/Iceweasel found!\n\nPlease start and quit Firefox (or Iceweasel) once for profil creation.' --title "JonDoFox Start"
        exit 1
    else
        zenity --error --title "JonDoFox Start" --text 'No profiles for Firefox/Iceweasel found!\n\nPlease start and quit Firefox (or Iceweasel) once for profil creation.' --no-wrap
        exit 1
    fi
    
fi

# Check for installed JonDofox
ret=$(grep JonDoFox "${HOME}/.mozilla/firefox/profiles.ini")
if [ "${ret}" ]; then
    # Version check
    VersionStrold=$(fgrep jondofox.profile_version ${HOME}/.mozilla/firefox/profile/prefs.js | xargs -I % expr % : ".*, \([0-9].*[0-9]\).*")
    VersionStrnew=$(fgrep jondofox.profile_version /usr/share/jondofox/profile/prefs.js | xargs -I % expr % : ".*, \([0-9].*[0-9]\).*")
    if [ "$VersionStrnew" != "$VersionStrold" ]; then
        jondofox-install
    fi
else
    # install new JonDoFox
    jondofox-install
    if [ $? -ne 0 ]; then
	exit 1
    fi
fi


if [ -x /usr/bin/iceweasel ]; then
    /usr/bin/iceweasel --no-remote -P JonDoFox
else 
    firefox --no-remote -P JonDoFox
fi