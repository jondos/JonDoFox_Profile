/* Copyright (C) 2006-2015 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function UpdateExtensions(){extensions={},simplePrefs.prefs["media-extensions"].split("|").forEach(function(e){extensions[e]=1})}function UpdateFilterOut(){filterOutRE=null;var e=simplePrefs.prefs["network-filter-out"];if(e)try{filterOutRE=new RegExp(e)}catch(t){}}function ListenResponse(e){function t(e){var t=null;try{t=i.getResponseHeader(e)}catch(n){}return t}function n(e){var t=null;try{t=i.getRequestHeader(e)}catch(n){}return t}function r(e,t,n){var r=Worker({window:g.top?g.top:g,contentScriptFile:self.data.url("pagedata-content.js")});r.port.on("pageurl",function(){try{r.port.emit("get-title",{specs:[e.spec]})}catch(t){if(r.tab){var n=/([^\/]*?)(?:\?.*)?$/.exec(r.tab.url)[1];m.title=n||_("media"),m.pageUrl=m.url,m.topUrl=m.pageUrl,m.isPrivate=privateBrowsing.isPrivate(r),NotifyHit(m)}r.detach()}}),r.port.on("pagedata",function(e){if(simplePrefs.prefs["smartnamer.enabled"]&&(m.title=e.title||_("media")),m.pageUrl=e.url,m.topUrl=t,m.isPrivate=privateBrowsing.isPrivate(r),r.tab){var i=viewFor(r.tab);try{i.getAttribute("remote")||(m.thumbnail=r.tab.getThumbnail())}catch(a){}m.topUrl=r.tab.url}s?tbvws.handleNetworkHook(s,m):m.extension&&"mp2t"==n?require("chunks").newChunk(m):NotifyHit(m),r.detach()})}var i=e.subject.QueryInterface(Ci.nsIHttpChannel),s=tbvws.networkHook(i.name);if(s||!filterOutRE||!filterOutRE.test(i.name)){var a=t("Content-Length");if(s||"0"!==a){var o=null,l=t("Content-Range");if(l){var u=RANGE_PATTERN.exec(l);u&&(o=u[1])}o||(o=a),o=parseInt(o);var c=EXT_PATTERN.exec(i.name);c&&!extensions[c[1]]&&(c=null);var p=t("Content-Type"),f=TYPE_PATTERN.exec(p);if((s||f||!isNaN(o)||c)&&(s||f||c||!(0==simplePrefs.prefs["mediaweight-threshold"]||o<simplePrefs.prefs["mediaweight-threshold"]))&&!(!s&&!isNaN(o)&&o<simplePrefs.prefs["mediaweight-min-size"]||!s&&filterOutRE&&filterOutRE.test(i.name)||!s&&f&&"ms-asf"==f[2]&&simplePrefs.prefs["exclude-msasf"])){var m={id:"network-probe:"+utils.md5(i.name),url:i.name},d=t("Content-Disposition");if(d){var v=CDFNAME_PATTERN.exec(d);v&&v[1]&&(m.headerFilename=v[1])}var h=NAME_PATTERN.exec(i.name);h&&(m.urlFilename=h[1]),m.title=m.headerFilename||m.urlFilename||_("media"),c?(m.type="video",m.extension=c[1]):f&&(m.type=f[1],m.extension=f[2]);var w=n("referer");w&&(m.referrer=w);var o=null,l=t("Content-Range");if(l){var u=RANGE_PATTERN.exec(l);u&&(o=u[1])}o||(o=a),o=parseInt(o),isNaN(o)||(m.length=o);var g=null;if(i.loadGroup&&i.loadGroup.notificationCallbacks)try{var E=i.loadGroup.notificationCallbacks.QueryInterface(Ci.nsIInterfaceRequestor);g=E.getInterface(Ci.nsIDOMWindow)}catch(R){}if(null==g&&i.notificationCallbacks)try{var x=i.notificationCallbacks.getInterface(Ci.nsILoadContext);x.topFrameElement&&(g=x.topFrameElement._contentWindow||null)}catch(R){}if(null==g&&i.notificationCallbacks)try{var b=i.notificationCallbacks.QueryInterface(Ci.nsIInterfaceRequestor);g=b.getInterface(Ci.nsIDOMWindow)}catch(R){}g&&timers.setTimeout(function(){var e=!1;try{e=/^(audio|video)/.test(g.document.contentType)}catch(t){}var n=g.top?g.top.document.URL:g.document.URL,i=m.extension?m.extension.toLowerCase():"",s=smartNames.specForUrl(n);if(!s.contentNeeded||e){m.pageUrl=g.document.URL,m.topUrl=g.top.document.URL,"obfuscated"==s.spec.mode&&(m.title=smartNames.getObfuscated(n)),m.isPrivate=privateBrowsing.isPrivate(g);for(var a in tabs){var o=tabs[a];if(o.url==n){var l=viewFor(o);try{l.getAttribute("remote")||(m.thumbnail=o.getThumbnail())}catch(t){}}}m.extension&&"mp2t"==i?require("chunks").newChunk(m):NotifyHit(m)}else s.spec.delay?timers.setTimeout(function(){r(s,n,i)},s.spec.delay):r(s,n,i)},0)}}}}function NotifyHit(e){listeners.forEach(function(t){t(e)})}function StartStop(e){var t=simplePrefs.prefs["network-probe"];t&&!e||!running?t&&!running&&(running=!0,UpdateFilterOut(),events.on("http-on-examine-response",ListenResponse),events.on("http-on-examine-cached-response",ListenResponse)):(running=!1,events.off("http-on-examine-response",ListenResponse),events.off("http-on-examine-cached-response",ListenResponse))}const simplePrefs=require("sdk/simple-prefs"),events=require("sdk/system/events"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,windowUtils=require("sdk/window/utils"),once=require("sdk/event/core").once,self=require("sdk/self"),_=require("sdk/l10n").get,tabs=require("sdk/tabs"),utils=require("utils"),privateBrowsing=require("sdk/private-browsing"),Worker=require("sdk/content/worker").Worker,tbvws=require("tbvws"),timers=require("sdk/timers"),viewFor=require("sdk/view/core").viewFor,smartNames=require("smartnames"),TYPE_PATTERN=new RegExp("^(audio|video)/(?:x-)?([^; ]+)"),RANGE_PATTERN=new RegExp("^bytes [0-9]+-[0-9]+/([0-9]+)$"),EXT_PATTERN=new RegExp("\\.([a-z0-9]{1,5})(?:\\?|#|$)","i"),NAME_PATTERN=new RegExp("/([^/]+?)(?:\\.([a-z0-9]{1,5}))?(?:\\?|#|$)","i"),CDFNAME_PATTERN=new RegExp('filename\\s*=\\s*"\\s*([^"]+?)\\s*"');var running=!1,listeners=[],extensions={};UpdateExtensions(),simplePrefs.on("media-extensions",UpdateExtensions);var filterOutRE=null;simplePrefs.on("network-filter-out",UpdateFilterOut),simplePrefs.on("network-probe",function(){StartStop()}),StartStop(),exports.addListener=function(e){listeners.push(e)},exports.removeListener=function(e){var t=listeners.indexOf(e);t>=0&&listeners.splice(t,1)},require("sdk/system/unload").when(function(){StartStop(!0)});