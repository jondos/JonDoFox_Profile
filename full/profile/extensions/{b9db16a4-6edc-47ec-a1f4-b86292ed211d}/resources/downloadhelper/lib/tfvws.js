/* Copyright (C) 2006-2015 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function DecodeVideoData(e,r){var t=/var *info *= *(.*),/.exec(r);if(t){var i=JSON.parse(t[1]),n={videoId:e.videoId,title:i.title||_("video"),topUrl:e.topUrl,from:"tfvws"},s=i.thumbnail_120_url||i.thumbnail_240_url||i.thumbnail_url;s&&(n.thumbnail=s),i.duration&&(n.duration=i.duration);var o=[];for(var a in i){var t=/^stream_(h264.*)_url$/.exec(a);t&&i[a]&&o.push(merge({itag:t[1],url:i[a],quality:t[1].toUpperCase()},VARIANTS_DESCRIPTION[t[1]]))}var u=variants.getHitsFromVariants(n,o);u.forEach(function(e){listeners.forEach(function(r){r(e)})})}}function GetVideoMeta(e){Request({url:e.baseUrl+"/embed/video/"+e.videoId,onComplete:function(r){DecodeVideoData(e,r.text)},headers:{referer:e.pageUrl}}).get()}const self=require("sdk/self"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,pageMod=require("sdk/page-mod"),Request=require("sdk/request").Request,simplePrefs=require("sdk/simple-prefs"),merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,privateBrowsing=require("sdk/private-browsing"),variants=require("variants");var OS=null,encoder=null,listeners=[];const PARAM_PATTERN=new RegExp("^(.*?)=(.*)$"),TYPE_PATTERN=new RegExp("^([^/;]+)/(?:x-)?([^/;]+)"),PM_PATTERN=new RegExp("^https?://([^/]*.)?dailymotion(.co)?.([^./]+)/.*"),VARIANTS_DESCRIPTION={h264:{extension:"mp4",size:"400x264",fps:"30"},h264_ld:{extension:"mp4",size:"320x216",fps:"30"},h264_hd1080:{extension:"mp4",size:"1920x1080",fps:"25"},h264_hd:{extension:"mp4",size:"1280x720",fps:"25"},h264_hq:{extension:"mp4",size:"848x480",fps:"25"}};pageMod.PageMod({include:PM_PATTERN,contentScriptFile:self.data.url("tfvws-content.js"),contentScriptWhen:"end",onAttach:function(e){e.port.on("detected-video",function(r){r.hasVideo&&(r.topUrl=e.tab.url,r.isPrivate=privateBrowsing.isPrivate(e),GetVideoMeta(r))})}}),exports.addListener=function(e){listeners.push(e)},exports.removeListener=function(e){var r=listeners.indexOf(e);r>=0&&listeners.splice(r,1)};