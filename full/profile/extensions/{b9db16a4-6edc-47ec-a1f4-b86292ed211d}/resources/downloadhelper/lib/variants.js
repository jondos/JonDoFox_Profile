/* Copyright (C) 2006-2015 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function EnsuresData(){simpleStorage.storage.variants||exports.resetVariants()}const $chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,simpleStorage=require("sdk/simple-storage"),simplePrefs=require("sdk/simple-prefs"),merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,TYPE_RE=new RegExp('^(audio|video)/(?:x\\-)?([^;]+)(?:;\\+codecs="(.+)")?$'),ADPID_RE=new RegExp("^([0-9]*)/([0-9]*)$"),SLASHID_RE=new RegExp("^(.*)/(.*)$"),ADPLISTID_RE=new RegExp("^adp:[0-9]+$");exports.resetVariants=function(){simpleStorage.storage.variants={full:{"tbvws:22":{extension:"mp4",quality:"hd720",audioCodec:"+mp4a.40.2",videoCodec:"avc1.64001F",enabled:!0,label:"MP4 - 1280x720",size:"1280x720"},"tbvws:18":{extension:"mp4",quality:"medium",audioCodec:"+mp4a.40.2",videoCodec:"avc1.42001E",enabled:!0,label:"MP4 - 480x360",size:"480x360"},"tbvws:43":{extension:"webm",quality:"medium",audioCodec:"+vorbis",videoCodec:"vp8.0",enabled:!0,label:"WEBM - 480x360",size:"480x360"},"tbvws:5":{extension:"flv",quality:"small",audioCodec:null,videoCodec:null,enabled:!0,label:"FLV - 320x240",size:"320x240"},"tbvws:36":{extension:"3gpp",quality:"small",audioCodec:"+mp4a.40.2",videoCodec:"mp4v.20.3",enabled:!0,label:"3GPP - 320x240",size:"320x240"},"tbvws:17":{extension:"3gpp",quality:"small",audioCodec:"+mp4a.40.2",videoCodec:"mp4v.20.3",enabled:!0,label:"3GPP - 176x144",size:"176x144"},"tfvws:h264_ld":{extension:"mp4",quality:"H264_LD",audioCodec:null,videoCodec:null,enabled:!0,label:"H264_LD - 320x216 - MP4",size:"320x216"},"tfvws:h264":{extension:"mp4",quality:"H264",audioCodec:null,videoCodec:null,enabled:!0,label:"H264 - 400x264 - MP4",size:"400x264"},"tfvws:h264_hd1080":{extension:"mp4",quality:"H264_HD1080",audioCodec:null,videoCodec:null,enabled:!0,label:"H264_HD1080 - 1920x1080 - MP4",size:"1920x1080"},"tfvws:h264_hd":{extension:"mp4",quality:"H264_HD",audioCodec:null,videoCodec:null,enabled:!0,label:"H264_HD - 1280x720 - MP4",size:"1280x720"},"tfvws:h264_hq":{extension:"mp4",quality:"H264_HQ",audioCodec:null,videoCodec:null,enabled:!0,label:"H264_HQ - 848x480 - MP4",size:"848x480"}},full_list:["tbvws:22","tbvws:18","adp:1","tbvws:5","tbvws:17","adp:2","tbvws:43","tbvws:36","tfvws:h264_hd1080","tfvws:h264_hd","tfvws:h264_hq","tfvws:h264","tfvws:h264_ld","adp:3","adp:4"],adp_audio:{140:{extension:"mp4",bitRate:"127856",codec:"mp4a.40.2"},171:{extension:"webm",bitRate:"133658",fps:"1",codec:"vorbis"}},adp_video:{133:{extension:"mp4",size:"320x240",bitRate:"248086",fps:"30",codec:"avc1.4d400d"},134:{extension:"mp4",size:"640x360",bitRate:"338730",fps:"30",codec:"avc1.4d401e"},135:{extension:"mp4",size:"854x480",bitRate:"721213",fps:"30",codec:"avc1.4d401f"},136:{extension:"mp4",size:"1280x720",bitRate:"1124376",fps:"30",codec:"avc1.4d401f"},137:{extension:"mp4",size:"1920x1080",bitRate:"4137966",fps:"30",codec:"avc1.640028"},160:{extension:"mp4",size:"192x144",bitRate:"111449",fps:"15",codec:"avc1.4d400c"},242:{extension:"webm",size:"320x240",bitRate:"180842",fps:"1",codec:"vp9"},243:{extension:"webm",size:"320x240",bitRate:"332350",fps:"1",codec:"vp9"},244:{extension:"webm",size:"854x480",bitRate:"419080",fps:"30",codec:"vp9"},247:{extension:"webm",size:"1280x720",bitRate:"877134",fps:"30",codec:"vp9"},248:{extension:"webm",size:"1920x1080",bitRate:"2835123",fps:"30",codec:"vp9"},264:{extension:"mp4",size:"2560x1440",bitRate:"9957081",fps:"25",codec:"avc1.640032"},266:{extension:"mp4",size:"3840x2160",bitRate:"22215059",fps:"25",codec:"avc1.640033"},271:{extension:"webm",size:"2560x1440",bitRate:"9227182",fps:"25",codec:"vp9"},278:{extension:"webm",size:"256x144",bitRate:"96779",fps:"1",codec:"vp9"},298:{extension:"mp4",size:"1280x720",bitRate:"3317977",fps:"60",codec:"avc1.4d4020"},299:{extension:"mp4",size:"1920x1080",bitRate:"5546416",fps:"60",codec:"avc1.64002a"},302:{extension:"webm",size:"1280x720",bitRate:"3752347",fps:"60",codec:"vp9"},303:{extension:"webm",size:"1920x1080",bitRate:"6088401",fps:"60",codec:"vp9"},313:{extension:"webm",size:"3840x2160",bitRate:"22856955",fps:"25",codec:"vp9"}},adp_list:["266/140","264/140","137/140","136/140","266/171","264/171","137/171","136/171","248/140","248/171","299/140","299/171","303/140","303/171","247/140","247/171","298/140","298/171","302/140","302/171","135/140","135/171","244/140","244/171","134/140","134/171","133/140","243/171","242/140","243/140","242/171","133/171","278/140","278/171","160/140","160/171","264/","133/","242/","243/","160/","/140","/171","136/","247/","135/","244/","134/","137/","248/","278/","299/","303/","298/","302/","266/","313/140","313/171","313/","271/140","271/171","271/"]}},exports.getHitsFromVariants=function(e,i,a){a=a||{},EnsuresData();var s={},t={},o=simplePrefs.prefs["ignore-protected"];i.forEach(function(i){if(i.url&&!(o&&!a.keepProtected&&i.s&&i.s.length>0)){s[i.itag]=i;var r=e.from+":"+i.itag,n="audio/video",d=null,l=null,p=null,u=simpleStorage.storage.variants.full[r];if(u)u.audioCodec&&(d=u.audioCodec,n="audio"),u.videoCodec&&(l=u.videoCodec,n=d?"audio/video":"video"),p=u.extension;else if(void 0!==i.type){var v=TYPE_RE.exec(i.type);if(v)if(p=v[2],"audio"==v[1])n="audio",d=v[3]||null;else if(v[3]){var c=v[3].split(",");1==c.length?(n="video",l=c[0]):(l=c[0],d=c[1])}else"video"==v[1]&&(n="video")}if(p=p||"mp4","audio/video"===n){var f={id:e.from+":"+e.videoId+":"+i.itag,url:i.url,extension:p};i.quality&&(f.quality=i.quality),d&&(f.audioCodec=d),l&&(f.videoCodec=l),i.size&&(f.size=i.size),i.fps&&(f.fps=i.fps),i.s&&(f._signature=i.s),t[r]=f;var u=simpleStorage.storage.variants.full[r];if(void 0===u){simpleStorage.storage.variants.full[r]={extension:p,quality:i.quality,audioCodec:d,videoCodec:l,enabled:!0};var g=[];if(g.push("("+r+")"),i.quality){var x="quality-"+i.quality,m=_(x);m==x&&(m=i.quality.toUpperCase()),g.push(m)}i.size&&g.push(i.size),g.push(p.toUpperCase()),l&&g.push("V/"+l),d&&g.push("A/"+d),simpleStorage.storage.variants.full[r].label=g.join(" - "),simpleStorage.storage.variants.full_list.push(r)}else!i.size&&u.size&&(f.size=u.size)}else{var b,h;if("audio"==n?(b="adp_audio",h="adp_video"):(b="adp_video",h="adp_audio"),void 0===simpleStorage.storage.variants[b][i.itag]){var z={extension:p};i.size&&(z.size=i.size),i.bitrate&&(z.bitRate=i.bitrate),i.fps&&(z.fps=i.fps),simpleStorage.storage.variants[b][i.itag]=z;for(var S in simpleStorage.storage.variants[h])simpleStorage.storage.variants.adp_list.push("audio"==n?S+"/"+i.itag:i.itag+"/"+S);"audio"==n?(simpleStorage.storage.variants[b][i.itag].codec=d,simpleStorage.storage.variants.adp_list.push("/"+i.itag)):(simpleStorage.storage.variants[b][i.itag].codec=l,simpleStorage.storage.variants.adp_list.push(i.itag+"/"))}}}});for(var r=e.maxVariants||simplePrefs.prefs["qualities-max"],n=0,d=[],l=null,p=0;p<simpleStorage.storage.variants.full_list.length&&(!r||r>n);p++){var u=simpleStorage.storage.variants.full_list[p],v=/^adp:([0-9]+)$/.exec(u);if(v){l||(l=[],simpleStorage.storage.variants.adp_list.forEach(function(i){if(!a.audioAndVideo||/^\d+\/\d+$/.test(i)){var t=ADPID_RE.exec(i);if(!(t[1].length>0&&!s[t[1]]||t[1].length>0&&simpleStorage.storage.variants.adp_video[t[1]]&&"vp9"==simpleStorage.storage.variants.adp_video[t[1]].codec&&simpleStorage.storage.converter&&!simpleStorage.storage.converter.vp9support||t[2].length>0&&!s[t[2]])){var o=s[t[1]],r=s[t[2]],n={id:e.from+":"+e.videoId+":"+i,_signature:[]},d=0;if(o){n.videoUrl=o.url,o.clen&&(d+=parseInt(o.clen)),r||(n.url=n.videoUrl),o.s&&n._signature.push(o.s);var p=simpleStorage.storage.variants.adp_video[t[1]];n.extension=o.extension||(p?p.extension:void 0),o.size&&(n.size=o.size),!n.size&&p&&p.size&&(n.size=p.size),o.fps&&(n.fps=o.fps),!n.fps&&p&&p.fps&&(n.fps=p.fps)}r&&(n.audioUrl=r.url,r.clen&&(d+=parseInt(r.clen)),o||(n.url=n.audioUrl,n.extension=r.extension),r.s&&n._signature.push(r.s)),d&&(n.length=d),l.push(n)}}}));var c=parseInt(v[1])-1;c<l.length&&(d[n++]=merge({order:n,adp:!0},e,l[c]))}else t[u]&&(d[n++]=merge({order:n},e,t[u]))}return d},exports.getVariantsList=function(){EnsuresData();var e=[],i=simplePrefs.prefs["adaptative-count"],a=1;for(simpleStorage.storage.variants.full_list.forEach(function(s){if(ADPLISTID_RE.test(s)){if(a>=i)return;e.push({id:"adp:"+a,label:_("adaptative",a)}),a++}else{var t=simpleStorage.storage.variants.full[s];t&&e.push({id:s,label:t.label,enabled:t.enabled})}});i>=a;a++)e.push({id:"adp:"+a,label:_("adaptative",a)});return e},exports.setVariantsList=function(e){simpleStorage.storage.variants.full_list=[],e.forEach(function(e){simpleStorage.storage.variants.full_list.push(e.id),ADPLISTID_RE.test(e.id)||(simpleStorage.storage.variants.full[e.id].enabled=e.enabled)})},exports.getAdpVariantsList=function(){EnsuresData();var e=[];return simpleStorage.storage.variants.adp_list.forEach(function(i){var a=SLASHID_RE.exec(i);if(i){var s=simpleStorage.storage.variants.adp_video[a[1]],t=simpleStorage.storage.variants.adp_audio[a[2]];if(s||t){var o=[];s&&!t?(o.push(_("video-only")),o.push(s.extension.toUpperCase())):!s&&t?(o.push(_("audio-only")),o.push(t.extension.toUpperCase())):o.push(s.extension.toUpperCase()),s&&(s.size&&o.push(s.size),s.fps&&o.push(s.fps+" fps"),s.codec&&o.push(s.codec)),t&&t.codec&&o.push(t.codec),e.push({id:i,label:o.join(" - ")})}}}),e},exports.setAdpVariantsList=function(e){simpleStorage.storage.variants.adp_list=[],e.forEach(function(e){simpleStorage.storage.variants.adp_list.push(e.id)})},exports.orderAdaptative=function(){simpleStorage.storage.variants.adp_list.sort(function(e,i){var a=SLASHID_RE.exec(e),s=SLASHID_RE.exec(i),t=simpleStorage.storage.variants.adp_video[a[1]],o=simpleStorage.storage.variants.adp_video[s[1]],r=simpleStorage.storage.variants.adp_audio[a[2]],n=simpleStorage.storage.variants.adp_audio[s[2]],d=t&&parseInt(t.size)||0,l=o&&parseInt(o.size)||0,p=r?1:0,u=n?1:0;return l*u-d*p})},exports.hasAudioVideo=function(e){var i={audio:!1,video:!1},a=simpleStorage.storage.variants.full[e];return a&&(i.audio=!!a.audioCodec,i.video=!!a.videoCodec),i};